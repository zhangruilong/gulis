<!DOCTYPE html>
<html lang="en">
<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Charisma, a fully featured, responsive, HTML5, Bootstrap admin template.">
<title>谷粒网</title>
<link rel="stylesheet" type="text/css" href="css/index.css"/>
<link rel="stylesheet" type="text/css" href="css/top1.css"/>
<link rel="stylesheet" type="text/css" href="css/news.css"/>
<link rel="stylesheet" type="text/css" href="css/bottom.css"/>
<link rel="stylesheet" type="text/css" href="css/plusslider.css"/>
<link rel="stylesheet" type="text/css" href="css/buy.css"/>
<link rel="stylesheet" type="text/css" href="css/pay.css"/>
<link rel="stylesheet" type="text/css" href="css/information.css"/>
<link rel="stylesheet" type="text/css" href="css/order.css"/>
<link rel="stylesheet" type="text/css" href="css/details.css"/>
<script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
<script type="text/javascript">
var customer = JSON.parse(window.localStorage.getItem("customer"));
</script>
</head>

<body>
    <div class="all">
        <div class="toptop">
           
                               <div class="topline">
    <div class="top">
                    <div class="toplineleft">
                        <a href="#"><img src="images/wjxt.jpg" width="12" height="11">收藏我们</a>
                        <span>中国消费增值示范企业</span>
                    </div>
                    <div class="menu">
                        <ul class="tlrtext">
                        <li><span class="topwelcome" id="index_login_button" style="color:#666666">欢迎来到谷粒网！</span></li>
                          
                          <li >
                          <a class="hide"><span style="color:#666666;">用户中心</span>
                          </a><span>|</span>
                            <ul >
                                <li><a href="#" id="user_accountinfo">基本信息</a></li>
                                <li><a href="#" id="topbar_userinfo">个人资料</a></li>
                                <li><a href="#" id="topbar_receive_address">收货地址</a></li>
                                <li><a href="#" id="topbar_collect">我的收藏</a></li>
                                <li><a href="#" id="topbar_jifen">我的积分</a></li>
                                <li><a href="#" id="topbar_comment">我的评价</a></li>
                                <li><a href="#" id="topbar_order">我的订单</a></li>
                            </ul>
                          </li>
                           
                            <li><a id="shopping_card_button" class="hide"><span ><img src="images/gouwuche.jpg" width="14" height="12" style="margin:13px 6px 0px 0px;width:12px;height:12px;"></span>
                             购物车 <font style="color:#d71600;">0</font> 件</a><span>|</span></li>
                             
                             <li><a class="hide"><span style="color:#666666;">联系客服</span>
                             </a><span>|</span>
                                <ul >
                                    <li><a href="#" id="topbar_tuikuan">申请退款</a></li>
                                    <li><a href="#" id="topbar_tuihuo">申请退换货</a></li>
                                    <li><a href="#" id="topbar_tuanjuan">查看团劵</a></li>
                                    <li><a href="#" id="topbar_bangdingshouji">换绑手机</a></li>
                                </ul>
                            </li>
                            
                             <li><a class="hide" style="border:0px;" id="more_button"><span style="color:#666666;">更多</span>
                             </a><span>|</span>
                                <ul >
                                    <li><a href="#" id="topbar_email_order">邮件订阅</a></li>
                                    <li><a href="#" id="topbar_collect_net">收藏本站</a></li>
                                    <li><a href="#" id="topbar_question">常见问题</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            
            
            <div class="logoline">
    <div class="top">
                    <div class="logoblock">
                        <div class="logoicon"><img src="images/logo.jpg" width="234" height="80" id="logo_index_img"></div>
                        
                    </div>
                    <div class="logosousuo">
                        <div class="nrssk">
                            <span><input class="nrsskinput1" type="text" name="textfield" id="textfield" /></span>
                            <span><input class="nrsskinput2" type="text" name="textfield" id="index_search_button" value="搜索"/></span>
                        </div>
                    </div>
                    <div class="zxfwblock"><img src="images/tuiguo.jpg" width="148" height="57"></div>
                </div>
           </div>
           
           <div class="navline">
    <div class="top">
                    <div class="navleft" id="index_navgation">
                     <span><a href="#" id="index_button">全部商品分类</a></span>
                        <span><a href="msgshow.html" >秒杀专区</a></span>
                       
                        <span><a href="mzgshow.html" >买赠专区</a></span>
                        <span><a onclick="dogoodsxdpage('G14630381061319233','');" href="gflshow.html" >品牌专区</a></span>
                        <span><a onclick="dogoodsxdpage('G14630381061319232','');" href="gflshow.html" >裸价专区</a></span>
                        
                        <span><a onclick="dogoodsxdpage('43','');" href="gflshow.html" >粮油米面</a></span>
                        <span><a onclick="dogoodsxdpage('42','');" href="gflshow.html" >调味酱汁</a></span>
                        <span><a onclick="dogoodsxdpage('41','');" href="gflshow.html" >南北干货</a></span>
                        <span><a onclick="dogoodsxdpage('39','');" href="gflshow.html" >餐厨用品</a></span>
                    </div>
                    
                </div>
           </div>
           
        </div>
        <div class="center">
            <div class="buyblock">
        <div class="buybleft">
            <div class="cardblline2">
                <div class="cardbl2left">购买步骤：</div>
                <div class="cardbl2right">
                    <img src="images/xzzf.png" width="713" height="35">
                   
                </div>
            </div>
            <div class="cardblblock4">
                <div class="cardblb4line"><span>商品清单</span><a onclick="javascript:history.go(-1)" style="cursor:pointer;">返回购物车</a></div>
                
                <div class="cardblxm">
                <div class="buyblxmline1" name="pay-TBheader">
                    
                    <div class="buyblxml1text1ba">商品名称</div>
                    
                    <div class="buyblxml1text2ba">数量</div>
                    <div class="buyblxml1text3ba">规格</div>
                    <div class="buyblxml1text3ba">单价</div>
                    <div class="buyblxml1text3ba">小计</div>
                    
                </div>
                <!-- <div class="buyblxmline2">
                   
                    <div class="buyblxml1text1bba"><img src="images/xmimg.jpg" width="63" height="39"><span>猫眼电影【限手机选座】选座票一张。中影/金逸/和平6店通兑</span></div>
                    
                    <div class="buyblxml1text2bba"><img src="images/jhicon.jpg" width="13" height="13" class="recue"><input type="text" name="textfield" class="amount_input" id="input_one"/><img src="images/jhicon.png" width="13" height="13" style="margin-left:0px;margin-top:46px;width:13px;height:13px;" class="add"></div>
                     <div class="buyblxml1text3bba">¥180</div>
                    <div class="buyblxml1text3bba">¥480</div>
                    <div class="buyblxml1text3bba">¥180</div>
                    
                </div>
                <div class="buyblxmline2">
                    
                    <div class="buyblxml1text1bba"><img src="images/xmimg.jpg" width="63" height="39"><span>猫眼电影【限手机选座】选座票一张。中影/金逸/和平6店通兑</span></div>
                    
                    <div class="buyblxml1text2bba"><img src="images/jhicon.jpg" width="13" height="13" class="recue"><input type="text" name="textfield" class="amount_input" id="input_two"/><img src="images/jhicon.png" width="13" height="13" style="margin-left:0px;margin-top:46px;width:13px;height:13px;" class="add"></div>
                    <div class="buyblxml1text3bba">¥180</div>
                    <div class="buyblxml1text3bba">¥480</div>
                    <div class="buyblxml1text3bba">¥180</div>
                    
                </div> -->
                <div class="buyblxmline3">
                <div class="buybltjddltext2">
                    <div class="buybltjddltline1">将发送谷粒网券密码至手机号：</div>
                    <!-- <div class="buybltjddltline2"><span>换号了？ </span> <span>绑定新手机号</span></div> -->
                </div>
                <div class="buyblxml3right"><span>已选</span><span class="buyblxml3text1">2</span><span>件商品</span><span class="buyblxml3text2">&nbsp;&nbsp;应付总额：</span><span class="buyblxml3text3">¥167.9</span>
                <!-- <br><span>温馨提示：到店还需支付</span><span class="buyblxml3text1">¥300</span><span>现金</span> -->
                </div>
                </div>
            </div>
            
            </div>
            <div class="cardblblock4" name="pay-address">
              <div class="cardblb4line"><span>送货地址</span></div>
              <!-- <div class="cardblb4line2">
              <input type="checkbox" value="" id="all_checkbox" />
              <span>联系人： </span><span name="pay-addcontact">陶璃超</span><span class="pay-addphone">18207194276</span>
              <span>地址： </span><span name="pay-addaddress">嘉兴市海盐县元通兔业专业合作社凤凰八组凤凰大道东8号</span>
              </div> -->
            </div>
            <div class="payxyblinez">
             <input type="button" name="button" id="pay_next_button" value="" onclick="sortingData()" /></div>
            <!--<div class="payxybline2"><a href="#">返回修改订单&nbsp;&nbsp;&nbsp;</a></div>-->
            
            
            
        </div>
        
    </div>
        </div>
        <div class="bottom" id="pay_bottom_container"></div>
        
    </div>

    <script type="text/javascript" src="js/base.js"></script>
    <script type="text/javascript" src="js/jquery.plusslider.js"></script>
    <script type="text/javascript" src="js/jquery.easing.1.3.js"></script>
    <script type="text/javascript" src="js/cart-pay.js"></script>
    <script type="text/javascript" src="js/js.js"></script>
    <script type="text/javascript" src="js/pay.js"></script>
<script type="text/javascript">
$(function(){
	var scompany = setscompany();
	var sdishes = JSON.parse(window.localStorage.getItem("sdishes"));
	$.each(scompany,function(i,item){
		$('.buybltjddltline1').text(item.companyshop);
		$(".buyblxml3right").append('<br><span class="buyblxml3text1">'+item.companydetail+'</span>');
	});
	showgszmoney();															//显示商品种类和总金额
	$.each(sdishes,function(i,item){
		$(".buyblxmline1[name='pay-TBheader']").after('<div class="buyblxmline2">'+
                '<div class="buyblxml1text1bba">'+
                	'<img src="'+item.goodsimage+'" width="63" height="39">'+
                	'<span>'+item.goodsname+'</span>'+
                '</div>'+
                '<div class="buyblxml1text2bba">'+item.orderdetnum+'</div>'+
                '<div class="buyblxml1text3bba">'+item.pricesunit+'</div>'+
                '<div class="buyblxml1text3bba">¥'+item.pricesprice+'</div>'+
                '<div class="buyblxml1text3bba">¥'+(item.pricesprice * item.orderdetnum)+'</div>'+
            '</div>');
	});
	$.ajax({
		url:"AddressAction.do?method=selAll",
		type:"post",
		data:{
			wheresql:"addresscustomer='"+customer.customerid+"'",
			order : "addressture desc"
		},
		success : function(resp){
			var data = JSON.parse(resp);
			$.each(data.root,function(i,item){
				$('div[name="pay-address"]').append('<div style="width:100%" class="cardblb4line2">'+
              '<input type="radio"/>'+
              '<span>联系人： </span><span name="pay-addcontact">'+item.addressconnect+'</span><span class="pay-addphone">'+item.addressphone+'</span>'+
              '<span>地址： </span><span name="pay-addaddress">'+item.addressaddress+'</span>'+
              '</div>');
			});
			$('div[name="pay-address"] input:eq(0)').attr("checked",true);
		},
		error : function(resp){
			var respText = eval('('+resp+')');
			alert(respText.msg);
		}
	});
});
//将购物车写入订单表
function buy(){
	$("#buyall").attr('onclick','');											//禁用按钮
	var scompany = JSON.parse(window.localStorage.getItem("scompany"));
	var ordermconnect = $('div[name="pay-address"] input:checked').nextAll('[name="pay-addcontact"]').text();
	var ordermphone = $('div[name="pay-address"] input:checked').nextAll('.pay-addphone').text();
	var ordermaddress = $('div[name="pay-address"] input:checked').nextAll('[name="pay-addaddress"]').text();
	var flag = 0;
	$.each(scompany, function(y, mcompany) {
		//alert(JSON.stringify(mcompany));
		var ordermjson = '[{"ordermcustomer":"' + customer.customerid
				+ '","ordermcompany":"' + mcompany.ordermcompany 
				+ '","ordermnum":"' + mcompany.ordermnum
				+ '","ordermmoney":"' + mcompany.ordermmoney
				+ '","ordermconnect":"' + ordermconnect
				+ '","ordermphone":"' + ordermphone
				+ '","ordermaddress":"' + ordermaddress
				+ '","ordermway":"货到付款"}]';
		var orderdetjson = '[';
		var sdishes = JSON.parse(window.localStorage.getItem("sdishes"));
		$.each(sdishes, function(i, item) {
			//alert(JSON.stringify(item));
			if(item.orderdtype == '秒杀' && item.orderdetnum > item.surplusnum){
				$(".meg").text("您购买的秒杀商品卖完了.......");
				$(".cd-popup-ok").attr("onclick","javascript:window.location.href = 'cart.jsp'");
				$('.cd-popup').addClass('is-visible');			//弹窗
				flag++;
				return false;
			}
			if(mcompany.ordermcompany == item.goodscompany)
				orderdetjson += '{"orderdid":"' + item.goodsid
						+ '","orderdcode":"' + item.goodscode
						+ '","orderdtype":"' + item.orderdtype
						+ '","orderdname":"' + item.goodsname
						+ '","orderddetail":"' + item.goodsdetail
						+ '","orderdunits":"' + item.goodsunits
						+ '","orderdprice":"' + item.pricesprice
						+ '","orderdunit":"' + item.pricesunit
						+ '","orderdclass":"' + item.goodsclassname
						+ '","orderdnum":"' + item.orderdetnum
						+ '","orderdmoney":"' + (item.pricesprice * item.orderdetnum).toFixed(2)
						+ '"},';
		});
		if(flag > 0){
			return false;
		}
		orderdetjson = orderdetjson.substr(0, orderdetjson.length - 1) + ']';
		saveOrder(ordermjson,orderdetjson);
     });
}
//保存订单和订单详情
function saveOrder(ordermjson,orderdetjson){
	var odjs = eval('('+ordermjson+')');
	$.ajax({
		url : 'OrdermAction.do?method=addOrder',
		type:"post",
		data : {
			json : ordermjson,
			orderdetjson : orderdetjson
		},
		success : function(resp) {
			var respText = eval('('+resp+')'); 
			if(respText.success == false) {
				alert(respText.msg);
			} else {
				window.localStorage.setItem("sdishes", "[]");
				window.localStorage.setItem("totalnum", 0);
				window.localStorage.setItem("totalmoney", 0);
				window.localStorage.setItem("cartnum", 0);
				alert("下单成功！");
				window.location.href = "payOK.html?odmmy="+odjs[0].ordermmoney+"&odmid="+respText.mOrdermid;
			}
		},
		error : function(resp) {
			$("#buyall").attr('onclick','sortingData();');//启用按钮
			alert('网络出现问题，请稍后再试');
		}
	});
}
//整理购物车数据
function sortingData(){
	if(confirm('确认货到付款么?') == false){
		return;
	}
	$("#pay_next_button").attr('onclick','');											//禁用按钮
	$.ajax({
		url:"OrderdAction.do?method=sortingSdiData",
		type:"post",
		data:{
			json:window.localStorage.getItem("sdishes"),
			customerid:customer.customerid
		},
		success:function(resp){
			var respText = eval('('+resp+')');
			if(respText.msg == '您购买的：'){
				var jsds = respText.root;										//sdishes的json
				window.localStorage.setItem("sdishes",JSON.stringify(jsds));
				var newcartnum = 0;
				var totalmoney = 0.00;
				var totalnum = 0;
				$.each(jsds,function(i,item){
					var money = parseFloat(parseFloat(item.pricesprice) * parseFloat(item.orderdetnum)).toFixed(2);
					newcartnum += parseInt(item.orderdetnum);
					totalmoney = parseFloat(money) + totalmoney;
					totalnum++;
				});
				window.localStorage.setItem("cartnum",newcartnum);
				window.localStorage.setItem("totalmoney",totalmoney.toFixed(2));
				window.localStorage.setItem("totalnum",totalnum);
				setscompany();		//设置供应商信息
				buy();
			} else {
				alert(respText.msg);
				var jsds = respText.root;										//sdishes的json
				window.localStorage.setItem("sdishes",JSON.stringify(jsds));
				var newcartnum = 0;
				var totalmoney = 0.00;
				var totalnum = 0;
				$.each(jsds,function(i,item){
					var money = parseFloat(parseFloat(item.pricesprice) * parseFloat(item.orderdetnum)).toFixed(2);
					newcartnum += parseInt(item.orderdetnum);
					totalmoney = parseFloat(money) + totalmoney;
					totalnum++;
				});
				window.localStorage.setItem("cartnum",newcartnum);
				window.localStorage.setItem("totalmoney",totalmoney.toFixed(2));
				window.localStorage.setItem("totalnum",totalnum);
				setscompany();		//设置供应商信息
				if(respText.root.length == 0){
					alert("购物车中没有商品.");
					window.location.href = "homepage.html";
					return;
				}
				buy();
			}
		},
		error : function(resp) {
			$("#buyall").attr('pay_next_button','sortingData()');								//启用按钮
			var respText = eval('('+resp+')');
			alert(respText.msg);
		}
	});
}
//显示商品种类和总金额
function showgszmoney(){
	$('.buyblxml3right span:eq(1)').text(window.localStorage.getItem("totalnum"));							//页面商品种类
	$('.buyblxml3right span:eq(4)').text('¥'+window.localStorage.getItem("totalmoney"));					//商品总金额
}
</script>

</body>
</html>

